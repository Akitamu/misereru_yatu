<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>360度画像VRビューア</title>
    <style>
      body {
        margin: 0;
      }
      canvas {
        display: block;
      }
      #permissionButton {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background-color: #008cba;
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="permissionButton">加速度センサーを有効にする</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.rawgit.com/mrdoob/three.js/r128/examples/js/controls/DeviceOrientationControls.js"></script>
    <script src="https://cdn.rawgit.com/mrdoob/three.js/r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.rawgit.com/mrdoob/three.js/r128/examples/js/effects/StereoEffect.js"></script>
    <script src="https://cdn.rawgit.com/mrdoob/three.js/r128/examples/js/vr/WebVR.js"></script>
    <script>
      var scene, camera, renderer, deviceControls, orbitControls, effect;

      function init() {
        // シーン、カメラ、レンダラーの初期化
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 360度画像のテクスチャをロード
        var textureLoader = new THREE.TextureLoader();
        textureLoader.load("./img/R0010006.JPG", function (texture) {
          var geometry = new THREE.SphereGeometry(500, 60, 40);
          var material = new THREE.MeshBasicMaterial({
            map: texture,
            side: THREE.DoubleSide,
          });
          var sphere = new THREE.Mesh(geometry, material);
          scene.add(sphere);
        });

        // カメラの位置を調整
        camera.position.set(0, 0, 0.1);

        // デバイスオリエンテーションコントロールの追加
        deviceControls = new THREE.DeviceOrientationControls(camera);

        // オービットコントロールの追加
        orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
        orbitControls.enableZoom = false;
        orbitControls.enablePan = false;

        // ステレオエフェクトの追加
        effect = new THREE.StereoEffect(renderer);
        effect.setSize(window.innerWidth, window.innerHeight);

        // レンダリングループ
        function animate() {
          requestAnimationFrame(animate);
          deviceControls.update();
          orbitControls.update();
          effect.render(scene, camera);
        }
        animate();

        // ウィンドウリサイズ対応
        window.addEventListener("resize", function () {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
          effect.setSize(window.innerWidth, window.innerHeight);
        });
      }

      document
        .getElementById("permissionButton")
        .addEventListener("click", function () {
          if (typeof DeviceMotionEvent.requestPermission === "function") {
            DeviceMotionEvent.requestPermission()
              .then((permissionState) => {
                if (permissionState === "granted") {
                  init();
                  document.getElementById("permissionButton").style.display =
                    "none";
                } else {
                  alert("加速度センサーの許可が必要です。");
                }
              })
              .catch(console.error);
          } else {
            // iOS 13以前や他のブラウザではそのまま初期化
            init();
            document.getElementById("permissionButton").style.display = "none";
          }
        });
    </script>
  </body>
</html>
